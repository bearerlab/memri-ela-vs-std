# MEMRI Pre-processing and Quality Control Code

This subdirectory contains the code or links to the GitHub repos for code used for processing MEMRI images and for performing quantitative quality assurance tests. All quality assurance code/analysis has a prefix "qa-". 

Please see Bearer Lab GitHub repositories for [Skull Stripping](https://github.com/bearerlab/skull-stripper), [Modal Scaling](https://github.com/bearerlab/modal-scaling), [Averaging Images with FSL](https://github.com/bearerlab/fsl-average), and [ROI analysis](https://github.com/bearerlab/memri-roi-measurement).  

## Repo File Structure 
```
memri-ela-vs-std/01_preprocessing/02_memri_preprocessing/
├── Slice_Interpolation.m            # Interpolates slices with RF feedthrough artifacts
├── See Bearer Lab GitHub Repo on Skull Stripping. 
├── See Bearer Lab GitHub Repo on Modal Scaling.
├── qa_snr_analysis.Rmd                 # MR Signal-to-Noise (SNR) comparisons
├── See Bearer Lab GitHub Repo on Averaging NIfTI files with FSL        # Visual Alignment Quality
├── qa_jaccard_similarity.sh         # Extracts Values to Determine Jaccard Indices to template
├── qa_jaccard_similarity.R          # Calculates, graphs, and tests differences in Jaccard Indices
├── qa_mutual_information.R          # Calculates, graphs, and tests differences in NMI
└── qa_roi_warped_v_smoothed.Rmd     # Determines the effect of smoothing on information
```

#### `slice_interpolation.m`
**Purpose:** To interpolate slices containing RF feedthrough artifacts with adjacent slice anatomy. 

**Dependencies:** None.

**Usage:** MATLAB run -- Currently only interpolates across Coronal slices.

**Inputs:** 1) Raw images; 2) Slice #'s or range of slices in need of interpolating

**Outputs:** Slice interpolated images


#### `snr_analysis.Rmd`
**Purpose:** To statistically compare and visualize SNR between groups - test whether there is a difference in MnCl2 dose via differences in SNR.

**Dependencies:** R/RStudio (see [requirements](../../requirements/requirements.md)).

**Usage:** Knit R Markdown File in R Studio

**Inputs:** CSV file generated by running ./ROI_feeder.sh 

**Outputs:** Statistical summaries and plots shown in Fig. S2D.

Note: For measurements, see [/02_roi_analysis/](../02_roi_analysis/README.md)


#### `SkullStrip.sh` & `skullstripper_v4.py`

**[See Skull Stripping Bearer Lab GitHub Repo](https://github.com/bearerlab/skull-stripper/tree/main)**

**Purpose:** To extract the brain from non-brain tissue 

**Dependencies:** FSL / NiftyReg

**Usage:** `./SkullStrip.sh <referencevolume> <referencemask> <pythonscript> <pythonversion>`

**Inputs:** 
    - Raw images with header correction, placed inside a directory called `Input`
    - Template image and mask, placed inside a directory called `Reference` 

**Outputs:** 
    - Masks (a `Masks` directory will be generated)
    - Skull Stripped Images (a `Stripped` directory will be generated)


#### `modal_scale_nii_int32.m` and others

**[See Modal Scaling Bearer Lab GitHub Repo](https://github.com/bearerlab/modal-scaling/tree/main)**

**Purpose:** To intensity normalize MEMRI images according to the modal intensity of a template.

**Dependencies:** MATLAB

**Usage:** Run in MATLAB. Use defaults for user input for _# bins_ and _delta_ values. 

**Inputs:** 
    - Skull-stripped linearly aligned images
    - Template image (single image or MDT) 

**Outputs:** 
    - Modally scaled images
    - Optional: PNGs of modally scaled histograms.


#### `average.sh`, `jaccard_similarity.sh`, `jaccard_similarity.R`, and `mutual_information.R`

For Average.sh please see Bearer Lab [FSL Average](https://github.com/bearerlab/fsl-average) GitHub Repo.

**Purpose:** To quantify anatomical similarity after linear/non-linear alignments. 

**Dependencies:** FSL (for .sh scripts) and R packages listed in /requirements/requirements.md.

**Usage:** 
    1) Run in WSL terminal - `average.sh` (requires input images to be organized in subdirectories for averaging).
    2) Run in WSL terminal - `jaccard_similarity.sh` (requires hard-coded directories and file names).
    3) Run in R/RStudio - `jaccard_similarity.R` (input is the output of (2)).
    4) Run in R/RStudio - `mutual_information.R` (must be placed inside directory with warped images).

**Inputs:** Warped (non-linearly aligned) images.

**Outputs:** Images for Fig. S2I, Jaccard Indices and Normalized Mutual Information Values and Fig. S2F.


#### `roi_warped_v_smoothed.Rmd`
**Purpose:** To determine if smoothing results in a difference/loss of information from MEMRI signal intensities. 

**Dependencies:** None.

**Usage:** Knit in RStudio. 

**Inputs:** ROI summary csv generated by ROI measurement scripts (see note below).

**Outputs:** Fig. S6 graphs and statistical summaries.

Note: For ROI measurements, see [/02_roi_analysis/](../02_roi_analysis/README.md)

