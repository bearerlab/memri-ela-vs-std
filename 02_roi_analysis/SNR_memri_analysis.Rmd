---
title: "ELA vs Std SNR Analysis"
author: "Taylor W. Uselman"
output:
  html_document: 
    toc: true
    number_sections: true
    toc_depth: 5
    code_folding: show
    theme: cerulean #spacelab yeti united cosmo | #prettydoc::html_pretty cayman tactile architect leonids hpstr
    highlight: tango
  pdf_document:
    df_print: kable
fontsize: 12pt
geometry: margin=0.25in
always_allow_html: yes
editor_options:
  chunk_output_type: inline
---

# Set Environment

```{R setup, include=FALSE}
# Format RMarkdown Parameters
# Ignore this code chunk unless errors occur when knitting to HTML/PDF.  
knitr::opts_chunk$set(comment = NA, message = FALSE, warning = FALSE, width = 100)
knitr::opts_chunk$set(fig.align = "center", fig.height = 4, fig.width = 8) # 4" x 8" unless otherwise specific
knitr::opts_chunk$set(cache = TRUE) # cache = FALSE may be needed, but be aware... this document will take a very long time to knit.
knitr::opts_chunk$set(echo = TRUE) # Code output is echoed/output immediately after the code in the .html file.


wdir <- "Local Directory" # USER INPUT NEEDED
setwd(wdir)
knitr::opts_knit$set(root.dir = wdir)
```


# Load Libraries

```{R}
# Data Processing
# citation()
library(openxlsx)
library(tidyverse)

# Data Graphics
library(ggplot2)

# Data Analysis
library(nlme) # Non-linear Mixed Effects Models
library(car) # Diagnostics
library(nortest)
library(emmeans) # Post-hoc pair-wise t-tests from NLME output, with multiple comparisons correction

source("./ada_functions.R") #Functions for assessing model residuals
```


# Load and Process Data

```{R}
filename <- paste0(getwd(),"/SNR.xlsx")

dat_MnII_roi <- read.xlsx(xlsxFile = filename,
                         sheet = 3,
                         colNames = TRUE, na.strings = "NA")

str(dat_MnII_roi)

dat_MnII_roi <- dat_MnII_roi %>%
  mutate(
    ELA = factor(ELA, levels = c("Normal","ELA")),
    Condition = factor(Condition, levels = c("PreMn","PostMn","D9PreMn","D9PostMn"),
                       labels = c("BL","HC","D9pre","D9post")),
    NUM = factor(parse_number(IMAGE)),
    MUSCLE.snr = `MUSCLE.(SNR)`,
    BRAIN.snr = `BRAIN.(SNR)`,
    MnDose = factor(ifelse(grepl("D9",Condition),2,1))
  ) %>% 
  group_by(
    Condition
  ) %>%
  mutate(
    ID = factor(1:n())
  ) %>% 
  ungroup() %>%
  select(ID,NUM,ELA,Condition,MnDose,MUSCLE.snr,BRAIN.snr)

dat_MnII_roi_long <- cbind.data.frame(
  rbind.data.frame(dat_MnII_roi %>% select(ID,NUM,ELA,Condition,MnDose,"SNR" = MUSCLE.snr),
                   dat_MnII_roi %>% select(ID,NUM,ELA,Condition,MnDose,"SNR" = BRAIN.snr)),
  "ROI" = factor(c(rep("Muscle",dim(dat_MnII_roi)[1]),
                   rep("Brain" ,dim(dat_MnII_roi)[1])),
                   levels = c("Muscle","Brain"))) %>%
  select(ID,NUM,ELA,Condition,MnDose,ROI,SNR) %>%
  arrange(ROI,ELA,Condition,NUM)


str(dat_MnII_roi_long)
summary(dat_MnII_roi_long)
head(dat_MnII_roi_long)
```

# Plot

```{R}
p = ggplot(dat_MnII_roi_long, aes(x = Condition, y=SNR, color=ELA, fill=ELA))
p = p + geom_boxplot(position=position_dodge(0.5),
                     color="black",alpha=0.5,
                     width=0.5, outlier.shape = NA)
p = p + geom_point(position=position_dodge(0.5), alpha=1, size=0.5)
p = p + scale_fill_manual(values=c("deepskyblue3","goldenrod3"))
p = p + scale_color_manual(values=c("deepskyblue4","goldenrod4"))
p = p + facet_grid(. ~ ROI)
p = p + theme(plot.title = element_blank()
              , axis.title.x = element_text(size=8,face="bold",family="sans")
              , axis.text.x = element_text(size=6,family="sans")
              , axis.title.y = element_text(size=8,face="bold",family="sans")
              , axis.text.y = element_text(size=6,family="sans")
              , strip.text = element_text(size=7.5,face="bold",family="sans")
              , strip.background = element_rect(fill = "white")
              , legend.position = "none")
              # , legend.title = element_blank()
              # , legend.text = element_text(size=7.5,face="bold",family="sans")
              # , legend.margin = margin(t = 0, unit='cm'))
p

# ggsave(filename="ELAvsNormal_Raw_SNR_Comparison_v1.tiff"
#        ,plot=p
#        ,device="tiff"
#        ,path=paste0(wdir)
#        ,width=90,height=55,units="mm",dpi=300)

```


# Analysis

## Comparison of ELA vs Normal SNR by ROI and Condition

### Setting Up Mixed-Effects LM with Compound Symmetry 
```{R}
lme.snr.rce <- lme(SNR ~ (ROI+Condition)*ELA,
                 random = ~ 1 | ID,
                 # correlation = corSymm(form = ~ 1 | ID),
                 method = "REML",
                 data = dat_MnII_roi_long  %>% na.omit()
                 )
```

### Checking LM Diagnostics

```{R}
qqPlot(lme.snr.rce$residuals)
bs_one_samp_dist(lme.snr.rce$residuals)


plot(lme.snr.rce$data$Condition,
     lme.snr.rce$residuals,
     main="Residuals by Condition")
bartlett.test(lme.snr.rce$data$SNR ~ lme.snr.rce$data$Condition)
leveneTest(lme.snr.rce$data$SNR ~ lme.snr.rce$data$Condition)

plot(lme.snr.rce$data$ROI,
     lme.snr.rce$residuals,
     main="Residuals by ROI")
bartlett.test(lme.snr.rce$data$SNR ~ lme.snr.rce$data$ROI)
leveneTest(lme.snr.rce$data$SNR ~ lme.snr.rce$data$ROI)

plot(lme.snr.rce$data$ELA,
     lme.snr.rce$residuals,
     main="Residuals by ELA")
bartlett.test(lme.snr.rce$data$SNR ~ lme.snr.rce$data$ELA)
leveneTest(lme.snr.rce$data$SNR ~ lme.snr.rce$data$ELA)
```

__Summary:__ Residuals do not drastically differ from normal and no single residual stands out as an influential outlier. There are some differences in the homogeneity across factors of ROI, but this might be expected. Slight differences might also be present when comparing conditions, but these are only marginally significant.


### Data Summary

```{R}
summary(lme.snr.rce)
anova(lme.snr.rce, type = "marginal")
emmeans(lme.snr.rce, specs = "ELA", by = c("Condition","ROI")) %>% pairs(adjust = "tukey")

emmeans(lme.snr.rce, specs = "Condition", by = c("ELA","ROI")) %>% pairs(adjust = "tukey")
```

